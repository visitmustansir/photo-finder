async function runMaintenance() {
    document.getElementById('start-btn').disabled = true;
    addLog("Fetching file list...", "text-indigo-400");

    try {
        const res = await fetch(APP_URL, { method: "POST", body: JSON.stringify({ action: "list_files" }) });
        let files = await res.json();
        
        // FIX: Ensure 'files' is an array. If it's an object containing the array, extract it.
        if (!Array.isArray(files)) {
            if (files.files && Array.isArray(files.files)) {
                files = files.files;
            } else {
                throw new Error("Data received from Google is not a list.");
            }
        }

        const broken = files.filter(f => !f.hasAI);
        
        if (broken.length === 0) {
            addLog("Database is 100% indexed. Nothing to fix!", "text-emerald-400");
            document.getElementById('start-btn').disabled = false;
            return;
        }

        addLog(`Repairing ${broken.length} files. Keep this tab open...`, "text-yellow-400");

        for (let i = 0; i < broken.length; i++) {
            const file = broken[i];
            try {
                // Using a proxy to bypass CORS issues when the AI "looks" at the Google Drive image
                const imgUrl = "https://images1-focus-opensocial.googleusercontent.com/gadgets/proxy?container=focus&refresh=2592000&url=" + encodeURIComponent("https://lh3.googleusercontent.com/d/" + file.id);
                
                const img = await faceapi.fetchImage(imgUrl);
                const detect = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                
                if (detect) {
                    await fetch(APP_URL, { 
                        method: "POST", 
                        body: JSON.stringify({ 
                            action: "update_metadata", 
                            fileId: file.id, 
                            descriptor: Array.from(detect.descriptor) 
                        }) 
                    });
                    addLog(`Successfully indexed: ${file.id}`, "text-emerald-500");
                } else {
                    addLog(`No face found in: ${file.id}`, "text-slate-500");
                }
            } catch (e) {
                addLog(`Error on ${file.id}: ${e.message}`, "text-red-400");
            }
            
            const percent = Math.round(((i + 1) / broken.length) * 100);
            document.getElementById('progress-bar').style.width = percent + "%";
            document.getElementById('progress-percent').innerText = percent + "%";
        }
        addLog("COMPLETE: Your library is now searchable.", "text-emerald-400");
    } catch (e) {
        addLog("Fatal Error: " + e.message, "text-red-500");
        document.getElementById('start-btn').disabled = false;
    }
}
