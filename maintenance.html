<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>High-Precision Repair - Photo Magic</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; }
        .log-box { background: #1e293b; height: 350px; overflow-y: auto; font-family: monospace; font-size: 11px; border: 1px solid #334155; }
    </style>
</head>
<body class="p-6 flex items-center justify-center min-h-screen">
    <div class="max-w-2xl w-full bg-slate-800 p-8 rounded-[2rem] shadow-2xl border border-slate-700">
        <h1 class="text-2xl font-bold mb-2 text-emerald-400">High-Precision Repair</h1>
        <p class="text-slate-400 mb-6 text-sm">Recalculating descriptors using SSD MobileNet V1 for maximum accuracy.</p>

        <div class="mb-6 p-5 bg-emerald-900/20 rounded-2xl border border-emerald-500/20 text-center">
            <div id="engine-status" class="text-[10px] font-bold uppercase tracking-widest text-emerald-300 mb-3 italic">Loading Heavy AI Models...</div>
            <button id="start-btn" disabled onclick="runMaintenance()" class="w-full bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-700 py-4 rounded-xl font-bold transition-all shadow-lg text-white">
                RE-INDEX DATABASE
            </button>
        </div>

        <div class="mb-4 text-center">
            <span id="file-count" class="text-xs text-slate-500 font-mono">Waiting for scan...</span>
        </div>

        <div class="mb-4">
            <div class="flex justify-between text-xs mb-2">
                <span class="text-slate-400 uppercase tracking-tighter">Repair Progress</span>
                <span id="progress-percent" class="text-emerald-400 font-bold">0%</span>
            </div>
            <div class="w-full bg-slate-900 rounded-full h-3 p-1">
                <div id="progress-bar" class="bg-emerald-500 h-1 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <div id="log" class="log-box p-4 rounded-xl mt-4">
            <div class="text-slate-500">> High-precision engine booting...</div>
        </div>
    </div>

    <script>
        const APP_URL = "https://script.google.com/macros/s/AKfycbz6r6S3clU5VWg5gAtaRlhTIKaBQ7Pf4TQbcBh3rUq-1lg_JLm9cH7DmYA_Jh2njBFC/exec";
        const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights/';
        const logBox = document.getElementById('log');

        function addLog(msg, color = "text-slate-300") {
            const div = document.createElement('div');
            div.className = "mb-1 " + color;
            div.innerText = `> ${msg}`;
            logBox.appendChild(div);
            logBox.scrollTop = logBox.scrollHeight;
        }

        async function init() {
            try {
                // Switching to SSD MobileNet for better accuracy
                await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                document.getElementById('engine-status').innerText = "High-Precision Mode Active";
                document.getElementById('start-btn').disabled = false;
                addLog("High-accuracy models loaded.");
            } catch (e) {
                addLog("Init Error: " + e.message, "text-red-400");
            }
        }

        async function runMaintenance() {
            document.getElementById('start-btn').disabled = true;
            addLog("Scanning database for re-indexing...", "text-emerald-400");

            try {
                const res = await fetch(APP_URL, { method: "POST", body: JSON.stringify({ action: "list_files" }) });
                const files = await res.json();
                
                // For a high-precision reset, we index EVERYTHING, not just broken ones
                addLog(`Found ${files.length} total images to verify.`);
                document.getElementById('file-count').innerText = `Target: ${files.length} images`;

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    try {
                        const imgDataRes = await fetch(APP_URL, { 
                            method: "POST", 
                            body: JSON.stringify({ action: "get_image_base64", fileId: file.id }) 
                        });
                        const imgData = await imgDataRes.json();
                        
                        const img = await faceapi.fetchImage(imgData.base64);
                        // Using SSD MobileNet options here
                        const detect = await faceapi.detectSingleFace(img, new faceapi.SsdMobilenetv1Options()).withFaceLandmarks().withFaceDescriptor();
                        
                        if (detect) {
                            await fetch(APP_URL, { 
                                method: "POST", 
                                body: JSON.stringify({ 
                                    action: "update_metadata", 
                                    fileId: file.id, 
                                    descriptor: Array.from(detect.descriptor) 
                                }) 
                            });
                            addLog(`Re-indexed: ${file.id}`, "text-emerald-500");
                        } else {
                            // If no face found, we clear the descriptor to prevent false matches
                            await fetch(APP_URL, { 
                                method: "POST", 
                                body: JSON.stringify({ 
                                    action: "update_metadata", 
                                    fileId: file.id, 
                                    descriptor: null 
                                }) 
                            });
                            addLog(`Cleared (No face): ${file.id}`, "text-slate-500");
                        }
                    } catch (e) {
                        addLog(`Error processing ${file.id}: ${e.message}`, "text-red-400");
                    }
                    
                    const percent = Math.round(((i + 1) / files.length) * 100);
                    document.getElementById('progress-bar').style.width = percent + "%";
                    document.getElementById('progress-percent').innerText = percent + "%";
                }
                addLog("HIGH-PRECISION REPAIR COMPLETE!", "text-emerald-400");
            } catch (e) {
                addLog("Fatal: " + e.message, "text-red-500");
                document.getElementById('start-btn').disabled = false;
            }
        }
        init();
    </script>
</body>
</html>
