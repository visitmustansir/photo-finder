<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Magic - UAE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader { border-top-color: #4f46e5; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #video-container { position: relative; width: 100%; max-width: 400px; display: none; margin: auto; overflow: hidden; border-radius: 1.5rem; }
        video { width: 100%; transform: scaleX(-1); }

        /* THE FACE FRAME OVERLAY */
        .face-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            border: 4px solid transparent;
            background: radial-gradient(circle at 50% 45%, transparent 120px, rgba(0,0,0,0.6) 121px);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .face-guide {
            width: 220px;
            height: 280px;
            border: 3px dashed #10b981;
            border-radius: 50% 50% 45% 45%;
            margin-top: -30px;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col items-center p-4 font-sans">
    <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl p-6 mt-6 text-center">
        <h1 class="text-3xl font-extrabold text-indigo-600 mb-1">ðŸ“¸ Photo Magic</h1>
        <p class="text-gray-400 mb-6 text-sm">Align face in the frame for AI search</p>

        <div id="video-container" class="shadow-inner bg-black">
            <video id="video" autoplay playsinline></video>
            <div class="face-overlay">
                <div class="face-guide"></div>
            </div>
            <button onclick="captureImage()" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-emerald-500 text-white px-8 py-3 rounded-full font-bold shadow-lg active:scale-95 transition">
                CAPTURE
            </button>
        </div>

        <div id="main-ui">
            <div class="bg-indigo-50 rounded-2xl p-5 mb-4 border border-indigo-100">
                <h3 class="font-bold text-gray-700 mb-3 text-left text-sm">Step 1: Upload Event Photos</h3>
                <input type="file" id="photoInput" multiple class="text-xs block w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-white file:text-indigo-700 mb-3">
                <button onclick="uploadPhotos()" id="uploadBtn" class="w-full bg-indigo-600 text-white font-bold py-2 rounded-xl hover:bg-indigo-700 transition shadow-md">Upload to Cloud</button>
            </div>

            <div class="bg-emerald-50 rounded-2xl p-5 border border-emerald-100">
                <h3 class="font-bold text-gray-700 mb-3 text-left text-sm">Step 2: Find Your Self</h3>
                <button onclick="startCamera()" id="searchBtn" class="w-full bg-emerald-500 text-white font-bold py-4 rounded-xl hover:bg-emerald-600 transition shadow-md">Open AI Face Scanner</button>
            </div>
        </div>

        <canvas id="canvas" class="hidden"></canvas>
        <div id="status" class="mt-6 text-sm font-semibold text-indigo-600"></div>
        <div id="gallery" class="grid grid-cols-2 gap-3 mt-6"></div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz6r6S3clU5VWg5gAtaRlhTIKaBQ7Pf4TQbcBh3rUq-1lg_JLm9cH7DmYA_Jh2njBFC/exec";
        let videoStream = null;

        async function uploadPhotos() {
            const files = document.getElementById('photoInput').files;
            const status = document.getElementById('status');
            if (files.length === 0) return alert("Please select files.");
            
            status.innerText = "Indexing images with AI...";
            for (let i = 0; i < files.length; i++) {
                const base64 = await toBase64(files[i]);
                await fetch(SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "upload", base64: base64.split(',')[1], mimeType: files[i].type, fileName: files[i].name })
                });
            }
            status.innerText = "âœ… All photos ready for search!";
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        async function startCamera() {
            const container = document.getElementById('video-container');
            const mainUi = document.getElementById('main-ui');
            const status = document.getElementById('status');
            
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                document.getElementById('video').srcObject = videoStream;
                container.style.display = "block";
                mainUi.style.display = "none";
                status.innerText = "Place face inside the dotted green frame";
            } catch (err) {
                alert("Please enable camera access.");
            }
        }

        async function captureImage() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const status = document.getElementById('status');
            const gallery = document.getElementById('gallery');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const selfieBase64 = canvas.toDataURL('image/jpeg', 0.6).split(',')[1];

            videoStream.getTracks().forEach(track => track.stop());
            document.getElementById('video-container').style.display = "none";
            document.getElementById('main-ui').style.display = "block";
            
            status.innerHTML = `<div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8 mx-auto mb-2"></div> AI is matching your landmarks...`;
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "search", base64: selfieBase64 })
                });
                const results = await response.json();
                gallery.innerHTML = "";
                
                if (results.length > 0 && !results[0].includes("No face")) {
                    status.innerText = `Found ${results.length} photos!`;
                    results.forEach(url => {
                        gallery.innerHTML += `<img src="${url}" class="rounded-2xl shadow-md border-2 border-white">`;
                    });
                } else {
                    status.innerText = "No photos found of you. Try again!";
                }
            } catch (e) { status.innerText = "Error connecting to AI."; }
        }
    </script>
</body>
</html>
