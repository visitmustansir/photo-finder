<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Event Finder Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader { border-top-color: #4f46e5; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #video-container { position: relative; width: 100%; max-width: 400px; display: none; margin: auto; overflow: hidden; border-radius: 2rem; border: 4px solid #4f46e5; }
        video { width: 100%; transform: scaleX(-1); }
        .face-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 45%, transparent 110px, rgba(15, 23, 42, 0.85) 111px); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .scanner-line { position: absolute; width: 100%; height: 2px; background: #10b981; top: 45%; animation: scan 3s ease-in-out infinite; box-shadow: 0 0 15px #10b981; }
        @keyframes scan { 0%, 100% { top: 30%; } 50% { top: 60%; } }
    </style>
</head>
<body class="bg-slate-900 min-h-screen flex flex-col items-center p-6 text-white font-sans">
    <div class="max-w-md w-full">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-black tracking-tighter text-indigo-400">AI SCANNER</h1>
            <p class="text-slate-400">Professional Face Matching System</p>
        </header>

        <div id="video-container" class="mb-6 shadow-2xl">
            <video id="video" autoplay playsinline></video>
            <div class="face-overlay">
                <div class="scanner-line"></div>
                <p class="mt-64 font-bold text-sm tracking-widest text-emerald-400">ALIGN BIOMETRICS</p>
            </div>
            <button onclick="captureImage()" class="absolute bottom-8 left-1/2 transform -translate-x-1/2 bg-white text-slate-900 px-10 py-4 rounded-full font-black text-xs tracking-widest hover:bg-emerald-400 transition-all">SCAN FACE</button>
        </div>

        <div id="main-ui" class="space-y-4">
            <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Database Management</h3>
                <input type="file" id="photoInput" multiple class="block w-full text-sm text-slate-400 mb-4 file:bg-indigo-600 file:text-white file:border-0 file:rounded-full file:px-4 file:py-2 file:mr-4 file:font-bold">
                <button onclick="uploadPhotos()" id="uploadBtn" class="w-full bg-slate-700 py-3 rounded-2xl font-bold hover:bg-indigo-600 transition">Index Event Photos</button>
            </div>

            <button onclick="startCamera()" id="searchBtn" class="w-full bg-indigo-600 py-6 rounded-3xl font-black text-lg shadow-xl shadow-indigo-900/20 hover:scale-[1.02] transition-transform">FIND MY PHOTOS</button>
        </div>

        <canvas id="canvas" class="hidden"></canvas>
        <div id="status" class="mt-8 text-center text-indigo-400 font-bold tracking-wide"></div>
        <div id="gallery" class="grid grid-cols-2 gap-4 mt-8"></div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz6r6S3clU5VWg5gAtaRlhTIKaBQ7Pf4TQbcBh3rUq-1lg_JLm9cH7DmYA_Jh2njBFC/exec";
        let videoStream = null;

        async function uploadPhotos() {
            const files = document.getElementById('photoInput').files;
            const status = document.getElementById('status');
            if (files.length === 0) return;
            status.innerText = "INITIALIZING BIOMETRIC INDEXING...";
            for (let i = 0; i < files.length; i++) {
                const base64 = await toBase64(files[i]);
                await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "upload", base64: base64.split(',')[1], mimeType: files[i].type, fileName: files[i].name }) });
                status.innerText = `PROGRESS: ${Math.round(((i+1)/files.length)*100)}%`;
            }
            status.innerText = "DATABASE UPDATED.";
        }

        const toBase64 = f => new Promise(res => { const r = new FileReader(); r.readAsDataURL(f); r.onload = () => res(r.result); });

        async function startCamera() {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            document.getElementById('video').srcObject = videoStream;
            document.getElementById('video-container').style.display = "block";
            document.getElementById('main-ui').style.display = "none";
        }

        async function captureImage() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const status = document.getElementById('status');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const base64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

            videoStream.getTracks().forEach(t => t.stop());
            document.getElementById('video-container').style.display = "none";
            document.getElementById('main-ui').style.display = "block";
            status.innerHTML = `<div class="loader rounded-full border-4 border-t-4 border-slate-800 h-8 w-8 mx-auto mb-4"></div> ANALYZING VECTORS...`;

            const r = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "search", base64: base64 }) });
            const res = await r.json();
            document.getElementById('gallery').innerHTML = "";
            if (res.length > 0 && !res[0].includes("No face")) {
                status.innerText = `MATCH FOUND: ${res.length} FILES`;
                res.forEach(url => { document.getElementById('gallery').innerHTML += `<img src="${url}" class="rounded-3xl border-2 border-slate-800">`; });
            } else { status.innerText = "NO MATCHES IN DATABASE."; }
        }
    </script>
</body>
</html>
